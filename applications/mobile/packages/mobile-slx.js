/*
 * 
 */
Ext.namespace("Mobile.SalesLogix");Mobile.SalesLogix.Application=Ext.extend(Sage.Platform.Mobile.Application,{defaultServerName:window.location.hostname,defaultVirtualDirectory:"sdata",defaultApplicationName:"slx",defaultContractName:"dynamic",defaultPort:window.location.port&&window.location.port!=80?window.location.port:false,defaultProtocol:/https/i.test(window.location.protocol)?"https":false,titleText:"Mobile Demo",constructor:function(a){Mobile.SalesLogix.Application.superclass.constructor.call(this);Ext.apply(this,a,{enableCaching:true,context:{},serverName:this.defaultServerName,virtualDirectory:this.defaultVirtualDirectory,applicationName:this.defaultApplicationName,contractName:this.defaultContractName,port:this.defaultPort,protocol:this.defaultProtocol})},setup:function(){Mobile.SalesLogix.Application.superclass.setup.apply(this,arguments);this.registerToolbar(new Sage.Platform.Mobile.MainToolbar({name:"tbar",title:this.titleText}));this.registerToolbar(new Sage.Platform.Mobile.FloatToolbar({name:"fbar"}));this.registerView(new Mobile.SalesLogix.LoginDialog());this.registerView(new Mobile.SalesLogix.SearchDialog());this.registerView(new Mobile.SalesLogix.Home());this.registerView(new Mobile.SalesLogix.Account.List());this.registerView(new Mobile.SalesLogix.Account.Detail());this.registerView(new Mobile.SalesLogix.Account.Edit());this.registerView(new Mobile.SalesLogix.Contact.List());this.registerView(new Mobile.SalesLogix.Contact.Detail());this.registerView(new Mobile.SalesLogix.Contact.List({id:"contact_related",expose:false}));this.registerView(new Mobile.SalesLogix.Opportunity.List());this.registerView(new Mobile.SalesLogix.Opportunity.Detail());this.registerView(new Mobile.SalesLogix.Opportunity.List({id:"opportunity_related",expose:false}))}});var App=new Mobile.SalesLogix.Application();Ext.namespace("Mobile.SalesLogix");Mobile.SalesLogix.Format=(function(){var a=Sage.Platform.Mobile.Format;return Ext.apply({},{address:function(e,d){var c=[];if(!a.isEmpty(e.Address1)){c.push(a.encode(e.Address1))}if(!a.isEmpty(e.Address2)){c.push(a.encode(e.Address2))}if(!a.isEmpty(e.Address3)){c.push(a.encode(e.Address3))}if(!a.isEmpty(e.Address4)){c.push(a.encode(e.Address4))}var b=[];if(!a.isEmpty(e.City)&&!a.isEmpty(a.encode(e.State))){b.push(a.encode(e.City)+",");b.push(a.encode(e.State))}else{if(!a.isEmpty(e.City)){b.push(a.encode(e.City))}if(!a.isEmpty(e.State)){b.push(a.encode(e.State))}}if(!a.isEmpty(e.PostalCode)){b.push(a.encode(e.PostalCode))}if(b.length>0){c.push(b.join(" "))}if(!a.isEmpty(e.Country)){c.push(a.encode(e.Country))}return d?c.join("\n"):c.join("<br />")},phone:function(b){if(typeof b!=="string"){return b}if(b.length!=10){return String.format('<a href="tel:{0}">{0}</a>',b)}return String.format('<a href="tel:{0}">({1}) {2}-{3}</a>',b,b.substring(0,3),b.substring(3,6),b.substring(6))},currency:function(d){var b=Mobile.SalesLogix.Format.fixed(d);var c=Math.floor(100*(b-Math.floor(b)));return String.format("${0}.{1}",(Math.floor(b)).toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,"),(c.toString().length<2)?"0"+c.toString():c.toString())},date:function(g,c){var d=/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(Z|(-|\+)(\d{2}):(\d{2}))/.exec(g);if(d){var f=new Date(Date.UTC(parseInt(d[1]),parseInt(d[2])-1,parseInt(d[3]),parseInt(d[4]),parseInt(d[5]),parseInt(d[6])));if(d[7]!=="Z"){var e=parseInt(d[9]);var b=parseInt(d[10]);if(d[8]==="-"){f.addMinutes((e*60)+b)}else{f.addMinutes(-1*((e*60)+b))}}return f.toString(c||"M/d/yyyy")}else{return g}},fixed:function(f,e){if(typeof e!=="number"){e=2}var b=Math.pow(10,e);var c=Math.floor(parseFloat(f)*b)/b;return c}},a)})();Ext.namespace("Mobile.SalesLogix");Mobile.SalesLogix.Template=(function(){return{nameLF:new Simplate(['{%= $["FirstName"] %}, {%= $["LastName"] %}'])}})();Ext.namespace("Mobile.SalesLogix");Mobile.SalesLogix.Home=Ext.extend(Sage.Platform.Mobile.View,{itemTemplate:new Simplate(["<li>",'<a href="#{%= id %}" target="_view">','{% if ($["icon"]) { %}','<img src="{%= $["icon"] %}" alt="icon" class="icon" />',"{% } %}","{%= title %}","</a>","</li>"]),constructor:function(a){Mobile.SalesLogix.Home.superclass.constructor.call(this);Ext.apply(this,a,{id:"home",title:"Home",selected:true})},render:function(){Mobile.SalesLogix.Home.superclass.render.call(this);var a=App.getViews();var c=[];for(var b=0;b<a.length;b++){if(a[b]!=this&&a[b].expose!=false){c.push(this.itemTemplate.apply(a[b]))}}Ext.DomHelper.append(this.el,c.join(""))},init:function(){Mobile.SalesLogix.Home.superclass.init.call(this);this.el.on("click",function(a,b,e){var c=Ext.get(b);var d;if(c.is('a[target="_view"]')||(d=c.up('a[target="_view"]'))){this.navigateToView(d||c,a)}},this,{preventDefault:true,stopPropagation:true});App.on("registered",this.viewRegistered,this)},navigateToView:function(b){if(b){var c=b.dom.hash.substring(1);var a=App.getView(c);if(a){a.show()}}},viewRegistered:function(a){Ext.DomHelper.append(this.el,this.itemTemplate.apply(a))},load:function(){Mobile.SalesLogix.Home.superclass.load.call(this);if(App.isOnline()||!App.enableCaching){var b=App.getService().getUserName();if(!b||!b.length){var a=App.getView("login_dialog");if(a){a.show()}}}}});Ext.namespace("Mobile.SalesLogix");Mobile.SalesLogix.LoginDialog=Ext.extend(Sage.Platform.Mobile.View,{viewTemplate:new Simplate(['<form id="{%= id %}" class="dialog">',"<fieldset>","<h1>{%= title %}</h1>",'<a class="button blueButton" target="_none"><span>Login</span></a>',"<label>user:</label>",'<input id="{%= id %}_user" type="text" name="user" value="lee" /><br />',"<label>pass:</label>",'<input id="{%= id %}_pass" type="text" name="password" />',"</fieldset>","</form>"]),constructor:function(a){Mobile.SalesLogix.LoginDialog.superclass.constructor.call(this);Ext.apply(this,a,{id:"login_dialog",title:"Login",expose:false});this.busy=false},init:function(){Mobile.SalesLogix.LoginDialog.superclass.init.call(this);this.el.select(".blueButton").on("click",function(a,b,c){this.login()},this,{preventDefault:true,stopPropagation:true})},login:function(){if(this.busy){return}var b=this.el.child('input[name="user"]').getValue();var a=this.el.child('input[name="password"]').getValue();this.validateCredentials(b,a)},validateCredentials:function(d,b){this.busy=true;this.el.addClass("dialog-busy");var a=App.getService().setUserName(d).setPassword(b);var c=new Sage.SData.Client.SDataResourceCollectionRequest(a).setResourceKind("users").setQueryArgs({select:"UserName",where:String.format('UserName eq "{0}"',d)}).setCount(1).setStartIndex(1);c.read({success:function(e){this.busy=false;this.el.removeClass("dialog-busy");if(e["$resources"].length<=0){a.setUserName(false).setPassword(false);alert("User does not exist.")}else{App.context.user=e["$resources"][0]["$key"];this.el.dom.removeAttribute("selected")}},failure:function(e,f){this.busy=false;this.el.removeClass("dialog-busy");a.setUserName(false).setPassword(false);if(e.status==403){alert("Username or password is invalid.")}else{alert("A problem occured on the server.")}},scope:this})}});Ext.namespace("Mobile.SalesLogix");Mobile.SalesLogix.SearchDialog=Ext.extend(Sage.Platform.Mobile.View,{viewTemplate:new Simplate(['<form id="{%= id %}" class="dialog">',"<fieldset>","<h1>{%= title %}</h1>",'<a type="cancel" class="button leftButton">Cancel</a>','<a class="button blueButton" target="_none">Search</a>',"<label>query:</label>",'<input id="{%= id %}_query" type="text" name="query" />',"</fieldset>","</form>"]),constructor:function(a){Mobile.SalesLogix.SearchDialog.superclass.constructor.call(this);Ext.apply(this,a,{id:"search_dialog",title:"Search",expose:false})},init:function(){Mobile.SalesLogix.SearchDialog.superclass.init.call(this);this.el.on("submit",function(a,b,c){return false},this,{preventDefault:true,stopPropagation:true}).dom.onsubmit=false;this.el.select(".leftButton").on("click",function(a,b,c){this.el.dom.removeAttribute("selected")},this,{preventDefault:true,stopPropagation:true});this.el.select(".blueButton").on("click",function(a,b,c){this.search()},this,{preventDefault:true,stopPropagation:true});this.el.select('input[name="query"]').on("keypress",function(a,b,c){if(a.getKey()==13||a.getKey()==10){a.stopEvent();if(/(iphone|ipad)/i.test(navigator.userAgent)){Ext.get("backButton").focus()}this.search()}},this)},show:function(a){this.context=a;this.el.child('input[name="query"]').dom.value=typeof this.context.query==="string"?this.context.query:"";Mobile.SalesLogix.SearchDialog.superclass.show.call(this);this.el.child('input[name="query"]').focus()},search:function(){var a=this.el.child('input[name="query"]').getValue();if(this.context&&this.context.fn){this.context.fn.call(this.context.scope||this,a)}this.el.dom.removeAttribute("selected")}});Ext.namespace("Mobile.SalesLogix.Account");Mobile.SalesLogix.Account.Detail=Ext.extend(Sage.Platform.Mobile.Detail,{constructor:function(a){Mobile.SalesLogix.Account.Detail.superclass.constructor.call(this);Ext.apply(this,a,{id:"account_detail",title:"Account",editor:"account_edit",resourceKind:"accounts"});this.layout=[{name:"AccountName",label:"name"},{name:"MainPhone",label:"phone",renderer:Mobile.SalesLogix.Format.phone},{name:"Address",label:"address",renderer:Mobile.SalesLogix.Format.address},{name:"WebAddress",label:"web",renderer:Mobile.SalesLogix.Format.link},{name:"Type",label:"type"},{name:"SubType",label:"sub-type"},{name:"AccountManager.UserInfo",label:"acct mgr",tpl:Mobile.SalesLogix.Template.nameLF},{name:"Owner.OwnerDescription",label:"owner"},{name:"Status",label:"status"},{name:"CreateDate",label:"create date",renderer:Mobile.SalesLogix.Format.date},{name:"CreateUser",label:"create user"},{options:{title:"Related Items",list:true},as:[{view:"contact_related",where:this.formatRelatedQuery.createDelegate(this,['Account.id eq "{0}"'],true),label:"Contacts",icon:"products/slx/images/Contacts_24x24.gif"},{view:"opportunity_related",where:this.formatRelatedQuery.createDelegate(this,['Account.id eq "{0}"'],true),label:"Opportunities",icon:"products/slx/images/Opportunity_List_24x24.gif"}]}]},init:function(){Mobile.SalesLogix.Account.Detail.superclass.init.call(this)},createRequest:function(){var a=Mobile.SalesLogix.Account.Detail.superclass.createRequest.call(this);a.setQueryArgs({include:"Address,AccountManager,AccountManager/UserInfo,Owner",select:["AccountName","MainPhone","Address/*","WebAddress","Type","SubType","AccountManager/UserInfo/FirstName","AccountManager/UserInfo/LastName","Owner/OwnerDescription","Status","CreateDate","CreateUser"].join(",")});return a}});Ext.namespace("Mobile.SalesLogix.Account");Mobile.SalesLogix.Account.Edit=Ext.extend(Sage.Platform.Mobile.Edit,{constructor:function(a){Mobile.SalesLogix.Account.Edit.superclass.constructor.call(this);Ext.apply(this,a,{id:"account_edit",title:"Account",resourceKind:"accounts"});this.layout=[{name:"AccountName",label:"name",type:"text"},{name:"Type",label:"type",type:"text"}]},init:function(){Mobile.SalesLogix.Account.Edit.superclass.init.call(this)},createRequest:function(){return new Sage.SData.Client.SDataSingleResourceRequest(this.getService()).setResourceKind(this.resourceKind).setQueryArgs({include:"Address,AccountManager,AccountManager/UserInfo,Owner",select:["AccountName","MainPhone","Address/*","WebAddress","Type","SubType","AccountManager/UserInfo/FirstName","AccountManager/UserInfo/LastName","Owner/OwnerDescription","Status","CreateDate","CreateUser"].join(",")}).setResourceSelector(String.format("'{0}'",this.entry["$key"]))}});Ext.namespace("Mobile.SalesLogix.Account");Mobile.SalesLogix.Account.List=Ext.extend(Sage.Platform.Mobile.List,{itemTemplate:new Simplate(["<li>",'<a href="#account_detail" target="_detail" m:key="{%= $key %}" m:descriptor="{%: $descriptor %}">','<h3>{%= $["AccountName"] %}</h3>','<h4>{%= $["Address"] ? $["Address"]["City"] : "" %}</h4>',"</a>","</li>"]),constructor:function(a){Mobile.SalesLogix.Account.List.superclass.constructor.call(this);Ext.apply(this,a,{id:"account_list",title:"Accounts",resourceKind:"accounts",pageSize:10,icon:"products/slx/images/Accounts_24x24.gif"});Ext.apply(this.tools||{},{fbar:[{name:"test",title:"note",cls:"tool-note",icon:"products/slx/images/Note_32x32.gif",fn:function(){alert("one")},scope:this},{name:"test2",title:"note",icon:"products/slx/images/Whats_New_3D_Files_32x32.gif",fn:function(){alert("two")},scope:this}]})},formatSearchQuery:function(a){return String.format('AccountName like "%{0}%"',a)},createRequest:function(){var a=Mobile.SalesLogix.Account.List.superclass.createRequest.call(this);a.setQueryArgs({include:"Address",orderby:"AccountName",select:"AccountName,Address/City"});return a}});Ext.namespace("Mobile.SalesLogix.Contact");Mobile.SalesLogix.Contact.Detail=Ext.extend(Sage.Platform.Mobile.Detail,{constructor:function(a){Mobile.SalesLogix.Contact.Detail.superclass.constructor.call(this);Ext.apply(this,a,{id:"contact_detail",title:"Contact",resourceKind:"contacts"});this.layout=[{label:"name",tpl:Mobile.SalesLogix.Template.nameLF},{name:"AccountName",label:"account",view:"account_detail",key:"Account.$key",property:true},{name:"WorkPhone",label:"work",renderer:Mobile.SalesLogix.Format.phone},{name:"Mobile",label:"mobile",renderer:Mobile.SalesLogix.Format.phone},{name:"Email",label:"email",renderer:Mobile.SalesLogix.Format.mail},{name:"Address",label:"address",renderer:Mobile.SalesLogix.Format.address},{name:"WebAddress",label:"web",renderer:Mobile.SalesLogix.Format.link},{name:"AccountManager.UserInfo",label:"acct mgr",tpl:Mobile.SalesLogix.Template.nameLF},{name:"Owner.OwnerDescription",label:"owner"},{name:"CreateDate",label:"create date",renderer:Mobile.SalesLogix.Format.date},{name:"CreateUser",label:"create user"},{options:{title:"Related Items",list:true},as:[{view:"opportunity_related",where:this.formatAccountRelatedQuery.createDelegate(this,['Account.id eq "{0}"'],true),label:"Opportunities",icon:"products/slx/images/Opportunity_List_24x24.gif"}]}]},formatAccountRelatedQuery:function(b,a){return String.format(a,b.Account["$key"])},init:function(){Mobile.SalesLogix.Contact.Detail.superclass.init.call(this)},createRequest:function(){var a=Mobile.SalesLogix.Contact.Detail.superclass.createRequest.call(this);a.setQueryArgs({include:"Account,Address,AccountManager,AccountManager/UserInfo",select:["Account/AccountName","FirstName","LastName","AccountName","WorkPhone","Mobile","Email","Address/*","WebAddress","AccountManager/UserInfo/FirstName","AccountManager/UserInfo/LastName","Owner/OwnerDescription","CreateDate","CreateUser"].join(",")});return a}});Ext.namespace("Mobile.SalesLogix.Contact");Mobile.SalesLogix.Contact.List=Ext.extend(Sage.Platform.Mobile.List,{itemTemplate:new Simplate(["<li>",'<a href="#contact_detail" target="_detail" m:key="{%= $key %}" m:descriptor="{%: $descriptor %}">',"<h3>{%= LastName %}, {%= FirstName %}</h3>","<h4>{%= AccountName %}</h4>","</a>","</li>"]),constructor:function(a){Mobile.SalesLogix.Contact.List.superclass.constructor.call(this);Ext.apply(this,a,{id:"contact_list",title:"Contacts",resourceKind:"contacts",pageSize:10,icon:"products/slx/images/Contacts_24x24.gif"})},formatSearchQuery:function(a){return String.format('(LastName like "%{0}%" or FirstName like "%{0}%")',a)},createRequest:function(){var a=Mobile.SalesLogix.Contact.List.superclass.createRequest.call(this);a.setResourceKind("contacts").setQueryArgs({orderby:"LastName,FirstName",select:"LastName,FirstName,AccountName"});return a}});Ext.namespace("Mobile.SalesLogix.Opportunity");Mobile.SalesLogix.Opportunity.Detail=Ext.extend(Sage.Platform.Mobile.Detail,{constructor:function(a){Mobile.SalesLogix.Opportunity.Detail.superclass.constructor.call(this);Ext.apply(this,a,{id:"opportunity_detail",title:"Opportunity",resourceKind:"opportunities"});this.layout=[{name:"Description",label:"name"},{name:"Account.AccountName",label:"account",view:"account_detail",key:"Account.$key",property:true},{name:"EstimatedClose",label:"est. close",renderer:Mobile.SalesLogix.Format.date},{name:"SalesPotential",label:"potential",renderer:Mobile.SalesLogix.Format.currency},{name:"CloseProbability",label:"probability"},{name:"Weighted",label:"weighted",renderer:Mobile.SalesLogix.Format.currency},{name:"Stage",label:"stage"},{name:"AccountManager.UserInfo",label:"acct mgr",tpl:Mobile.SalesLogix.Template.nameLF},{name:"Owner.OwnerDescription",label:"owner"},{name:"Status",label:"status"},{name:"CreateDate",label:"create date",renderer:Mobile.SalesLogix.Format.date},{name:"CreateUser",label:"create user"}]},init:function(){Mobile.SalesLogix.Opportunity.Detail.superclass.init.call(this)},createRequest:function(){var a=Mobile.SalesLogix.Opportunity.Detail.superclass.createRequest.call(this);a.setQueryArgs({include:"Account,AccountManager,AccountManager/UserInfo",select:["Description","Account/AccountName","EstimatedClose","SalesPotential","CloseProbability","Weighted","Stage","AccountManager/UserInfo/FirstName","AccountManager/UserInfo/LastName","Owner/OwnerDescription","Status","CreateDate","CreateUser"].join(",")});return a}});Ext.namespace("Mobile.SalesLogix.Opportunity");Mobile.SalesLogix.Opportunity.List=Ext.extend(Sage.Platform.Mobile.List,{itemTemplate:new Simplate(["<li>",'<a href="#opportunity_detail" target="_detail" m:key="{%= $key %}" m:descriptor="{%: $descriptor %}">','<h3>{%= $["Description"] %}</h3>','<h4>{%= $["Account"]["AccountName"] %}</h4>',"</a>","</li>"]),constructor:function(a){Mobile.SalesLogix.Opportunity.List.superclass.constructor.call(this);Ext.apply(this,a,{id:"opportunity_list",title:"Opportunities",resourceKind:"opportunities",pageSize:10,icon:"products/slx/images/Opportunity_List_24x24.gif"})},formatSearchQuery:function(a){return String.format('(Description like "%{0}%")',a)},createRequest:function(){var a=Mobile.SalesLogix.Opportunity.List.superclass.createRequest.call(this);a.setQueryArgs({include:"Account",orderby:"Description",select:"Description,Account/AccountName"});return a}});