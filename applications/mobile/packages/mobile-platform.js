/*
 * 
 */
Ext.namespace("Sage.Platform.Mobile");Ext.USE_NATIVE_JSON=true;Sage.Platform.Mobile.Application=Ext.extend(Ext.util.Observable,{constructor:function(){Sage.Platform.Mobile.Application.superclass.constructor.call(this);this.initialized=false;this.enableCaching=false;this.context={};this.views=[];this.viewsById={};this.addEvents("registered","search","edit","save","refresh")},setup:function(){Ext.getBody().on("beforetransition",function(b,c,d){var a=this.getView(c);if(a){if(b.browserEvent.out){this.beforeViewTransitionAway(a)}else{this.beforeViewTransitionTo(a)}}},this);Ext.getBody().on("aftertransition",function(b,c,d){var a=this.getView(c);if(a){if(b.browserEvent.out){this.viewTransitionAway(a)}else{this.viewTransitionTo(a)}}},this);if(this.service&&this.enableCaching){if(this.isOnline()){this.clearSDataRequestCache()}this.service.on("beforerequest",this.loadSDataRequest,this);this.service.on("requestcomplete",this.cacheSDataRequest,this)}},isOnline:function(){return window.navigator.onLine},clearSDataRequestCache:function(){var a=function(d){if(/^\[sdata\]\:/i.test(d)){console.log("clearing cache: %s",d);window.localStorage.removeItem(d)}};if(Ext.isGecko){for(var c=0;c<window.localStorage.length;c++){a(window.localStorage.key(c))}}else{for(var b in window.localStorage){a(b)}}},createCacheKey:function(a){return"[sdata] "+a.toString()},loadSDataRequest:function(b,d){if(this.isOnline()){return}var a=this.createCacheKey(b);var c=window.localStorage.getItem(a);if(c){console.log("cache hit: %s",a);d.result=Ext.decode(c)}},cacheSDataRequest:function(b,d,c){if(typeof c==="object"){var a=this.createCacheKey(b);console.log("caching: %s",a);window.localStorage.removeItem(a);window.localStorage.setItem(a,Ext.encode(c))}},init:function(){this.setup();if(this.tbar){this.tbar.init()}for(var a=0;a<this.views.length;a++){this.views[a].init()}this.initialized=true},registerView:function(a){this.views.push(a);this.viewsById[a.id]=a;if(this.initialized){a.init()}this.fireEvent("registered",a)},getViews:function(){return this.views},getActiveView:function(){var a=iui.getCurrentPage()||iui.getCurrentDialog();if(a){return this.getView(a)}return null},getPreviousView:function(){var a=iui.getPreviousPage();if(a){return this.getView(a)}return null},getView:function(a){if(a){if(typeof a==="string"){return this.viewsById[a]}if(typeof a==="object"&&typeof a.id==="string"){return this.viewsById[a.id]}}return null},getService:function(){return this.service},setTitle:function(a){if(this.tbar&&this.tbar.setTitle){this.tbar.setTitle(a)}},allowSearch:function(b,a){if(this.tbar&&this.tbar.allowSearch){this.tbar.allowSearch(b,a)}},allowEdit:function(a){if(this.tbar&&this.tbar.allowEdit){this.tbar.allowEdit(a)}},allowSave:function(a){if(this.tbar&&this.tbar.allowSave){this.tbar.allowSave(a)}},beforeViewTransitionAway:function(a){this.allowSearch(false);this.allowEdit(false);this.allowSave(false);a.beforeTransitionAway()},beforeViewTransitionTo:function(a){a.beforeTransitionTo()},viewTransitionAway:function(a){a.transitionAway()},viewTransitionTo:function(a){this.allowSearch(a.canSearch,a.queryText);this.allowEdit(a.canEdit);this.allowSave(a.canSave);a.transitionTo()}});Ext.namespace("Sage.Platform.Mobile");Sage.Platform.Mobile.View=Ext.extend(Ext.util.Observable,{viewTemplate:new Simplate(['<ul id="{%= id %}" title="{%= title %}" {% if (selected) { %} selected="true" {% } %}>',"</ul>"]),constructor:function(a){Sage.Platform.Mobile.View.superclass.constructor.call(this);Ext.apply(this,a,{id:"view",title:"",canSearch:false});this.loaded=false},render:function(){this.el=Ext.DomHelper.append(Ext.getBody(),this.viewTemplate.apply(this),true)},init:function(){this.render();this.el.on("load",function(a,b,c){if(this.loaded==false){this.load();this.loaded=true}},this)},setTitle:function(a){this.el.dom.setAttribute("title",a)},load:function(){},show:function(){iui.showPage(this.el.dom)},beforeTransitionTo:function(){},beforeTransitionAway:function(){},transitionTo:function(){},transitionAway:function(){},getService:function(){return App.getService()}});Ext.namespace("Sage.Platform.Mobile");Sage.Platform.Mobile.List=Ext.extend(Sage.Platform.Mobile.View,{viewTemplate:new Simplate(['<ul id="{%= id %}" title="{%= title %}">',"</ul>"]),contentTemplate:new Simplate(['<li class="loading"><div class="loading-indicator">loading...</div></li>','<li class="more" style="display: none;"><a href="#" target="_none" class="whiteButton moreButton"><span>More</span></a></li>']),itemTemplate:new Simplate(["<li>",'<a href="#" target="_detail" m:key="{%= $key %}">',"<h3>{%= $descriptor %}</h3>","</a>","</li>"]),noDataTemplate:new Simplate(['<li class="no-data">',"<h3>{%= noDataText %}</h3>","</li>"]),constructor:function(a){Sage.Platform.Mobile.List.superclass.constructor.call(this);Ext.apply(this,a,{id:"generic_list",title:"List",pageSize:20,requestedFirstPage:false,canSearch:true,noDataText:"no records"})},render:function(){Sage.Platform.Mobile.List.superclass.render.call(this);this.clear()},init:function(){Sage.Platform.Mobile.List.superclass.init.call(this);this.el.on("click",function(a,b,e){var c=Ext.get(b);var d;if(c.is(".more")||(c.up(".more"))){this.more(a)}else{if(c.is('a[target="_detail"]')||(d=c.up('a[target="_detail"]'))){this.navigateToDetail(d||c,a)}}},this,{preventDefault:true,stopPropagation:true});if(this.canSearch){App.on("search",function(a){if(this.el.getAttribute("selected")=="true"){this.search(a)}},this)}App.on("refresh",function(a){if(this.resourceKind&&a.resourceKind===this.resourceKind){this.clear()}},this)},search:function(a){this.clear();this.queryText=a&&a.length>0?a:false;this.query=this.queryText!==false?this.formatSearchQuery(this.queryText):false;App.allowSearch(this.canSearch,this.queryText);this.requestData()},formatSearchQuery:function(a){return false},createRequest:function(){var a=this.pageSize;var e=this.feed&&this.feed["$startIndex"]>0&&this.feed["$itemsPerPage"]>0?this.feed["$startIndex"]+this.feed["$itemsPerPage"]:1;var c=new Sage.SData.Client.SDataResourceCollectionRequest(this.getService()).setCount(a).setStartIndex(e);if(this.resourceKind){c.setResourceKind(this.resourceKind)}var b=[];var d;if(this.context&&(d=this.expandExpression(this.context.where))){b.push(d)}if(this.query){b.push(this.query)}if(b.length>0){c.setQueryArgs({where:b.join(" and ")})}return c},navigateToDetail:function(b){if(b){var d=b.dom.hash.substring(1);var a=b.getAttribute("key","m");var c=b.getAttribute("descriptor","m");App.getView(d).show({descriptor:c,key:a})}},processFeed:function(b){if(this.requestedFirstPage==false){this.requestedFirstPage=true;this.el.select(".loading").remove()}this.feed=b;if(this.feed["$totalResults"]===0){Ext.DomHelper.insertBefore(this.moreEl,this.noDataTemplate.apply(this))}else{var c=[];for(var a=0;a<b.$resources.length;a++){c.push(this.itemTemplate.apply(b.$resources[a]))}if(c.length>0){Ext.DomHelper.insertBefore(this.moreEl,c.join(""))}}this.moreEl.removeClass("more-loading");if(this.hasMoreData()){this.moreEl.show()}else{this.moreEl.hide()}},hasMoreData:function(){if(this.feed["$startIndex"]>0&&this.feed["$itemsPerPage"]>0&&this.feed["$totalResults"]>=0){var c=this.feed["$startIndex"];var b=this.feed["$itemsPerPage"];var a=this.feed["$totalResults"];return(c+b<=a)}else{return true}},requestFailure:function(a,b){},requestData:function(){var a=this.createRequest();a.read({success:function(b){this.processFeed(b)},failure:function(b,c){this.requestFailure(b,c)},scope:this})},more:function(){this.moreEl.addClass("more-loading");this.requestData()},expandExpression:function(a){if(typeof a==="function"){return a.call(this)}else{return a}},hasContext:function(){return(this.context||this.newContext)},isNewContext:function(){if(!this.context){return true}return(this.expandExpression(this.context.where)!=this.expandExpression(this.newContext.where))},beforeTransitionTo:function(){Sage.Platform.Mobile.List.superclass.beforeTransitionTo.call(this);if(this.hasContext()&&this.isNewContext()){this.clear()}},transitionTo:function(){Sage.Platform.Mobile.List.superclass.transitionTo.call(this);if(this.hasContext()&&this.isNewContext()){this.context=this.newContext}if(this.requestedFirstPage==false){this.requestData()}},show:function(a){this.newContext=a;Sage.Platform.Mobile.List.superclass.show.call(this)},clear:function(){this.el.update(this.contentTemplate.apply(this));this.moreEl=this.el.down(".more");this.requestedFirstPage=false;this.feed=false;this.query=false;this.queryText=false}});Ext.namespace("Sage.Platform.Mobile");Sage.Platform.Mobile.Detail=Ext.extend(Sage.Platform.Mobile.View,{viewTemplate:new Simplate(['<div id="{%= id %}" title="{%= title %}" class="panel">',"</div>"]),contentTemplate:new Simplate(['<fieldset class="loading">','<div class="row"><div class="loading-indicator">loading...</div></div>',"</fieldset>",]),sectionBeginTemplate:new Simplate(['<h2>{%= $["title"] || "Details" %}</h2>','{% if ($["list"]) { %}<ul>{% } else { %}<fieldset>{% } %}']),sectionEndTemplate:new Simplate(['{% if ($["list"]) { %}</ul>{% } else { %}</fieldset>{% } %}']),propertyTemplate:new Simplate(['<div class="row">',"<label>{%= label %}</label>","<span>{%= value %}</span>","</div>"]),relatedPropertyTemplate:new Simplate(['<div class="row">',"<label>{%= label %}</label>",'<a href="#{%= view %}" target="_related" m:key="{%= key %}">{%= value %}</a>',"</div>"]),relatedTemplate:new Simplate(["<li>",'<a href="#{%= view %}" target="_related" m:where="{%= where %}">','{% if ($["icon"]) { %}','<img src="{%= $["icon"] %}" alt="icon" class="icon" />',"{% } %}","{%= label %}","</a>","</li>"]),constructor:function(a){Sage.Platform.Mobile.Detail.superclass.constructor.call(this);Ext.apply(this,a,{id:"generic_detail",title:"Detail",expose:false,canEdit:false,editor:false})},render:function(){Sage.Platform.Mobile.Detail.superclass.render.call(this);this.clear()},init:function(){Sage.Platform.Mobile.Detail.superclass.init.call(this);this.el.on("click",function(a,b,e){var c=Ext.get(b);var d;if(c.is('a[target="_related"]')||(d=c.up('a[target="_related"]'))){a.stopEvent();this.navigateToRelated(d||c,a)}},this);App.on("edit",function(){if(this.el.getAttribute("selected")=="true"){this.navigateToEdit()}},this);App.on("refresh",function(a){if(this.context&&a.key===this.context.key){if(a.data&&a.data["$descriptor"]){this.setTitle(a.data["$descriptor"])}this.clear()}},this)},formatRelatedQuery:function(b,a){return String.format(a,b["$key"])},navigateToEdit:function(){var a=App.getView(this.editor);if(a){a.show(this.entry)}},navigateToRelated:function(f,b){var e=false;var c=f.getAttribute("where","m");var d=f.getAttribute("key","m");if(d){e={key:d}}else{if(c){e={where:c}}}if(e){var g=f.dom.hash.substring(1);var a=App.getView(g);if(a){a.show(e)}}},createRequest:function(){var a=new Sage.SData.Client.SDataSingleResourceRequest(this.getService()).setResourceSelector(String.format("'{0}'",this.context.key));if(this.resourceKind){a.setResourceKind(this.resourceKind)}return a},processLayout:function(c,l,h){var k=[];var e=[];e.push(this.sectionBeginTemplate.apply(l));for(var b=0;b<c.length;b++){var d=c[b];if(d.as){k.push(d);continue}else{if(d.view&&d.property!==true){var j=Ext.apply({},d);if(j.where){j.where=typeof j.where==="function"?Sage.Platform.Mobile.Format.encode(j.where(h)):Sage.Platform.Mobile.Format.encode(j.where)}e.push(this.relatedTemplate.apply(j));continue}else{var f=d.provider||Sage.Platform.Mobile.Utility.getValue;var g=f(h,d.name);var a=d.tpl?d.tpl.apply(g):d.renderer?d.renderer(g):g;if(d.view&&d.key){e.push(this.relatedPropertyTemplate.apply({name:d.name,label:d.label,renderer:d.renderer,provider:d.provider,entry:h,raw:g,value:a,key:f(h,d.key),view:d.view}))}else{e.push(this.propertyTemplate.apply({name:d.name,label:d.label,renderer:d.renderer,provider:d.provider,entry:h,raw:g,value:a}))}}}}e.push(this.sectionEndTemplate.apply(l));Ext.DomHelper.append(this.el,e.join(""));for(var b=0;b<k.length;b++){var d=k[b];this.processLayout(d.as,d.options,h)}},requestFailure:function(a,b){},requestData:function(){var a=this.createRequest();a.read({success:function(b){this.el.select(".loading").remove();this.entry=b;if(this.entry){this.processLayout(this.layout,{},this.entry)}},failure:function(b,c){this.requestFailure(b,c)},scope:this})},show:function(a){if(a){if(a.key){this.newContext=a}if(a.descriptor){this.setTitle(a.descriptor)}}Sage.Platform.Mobile.Detail.superclass.show.call(this)},isNewContext:function(){return(!this.context||(this.context&&this.context.key!=this.newContext.key))},beforeTransitionTo:function(){Sage.Platform.Mobile.Detail.superclass.beforeTransitionTo.call(this);this.canEdit=this.editor?true:false;if(this.isNewContext()){this.clear()}},transitionTo:function(){Sage.Platform.Mobile.Detail.superclass.transitionTo.call(this);if(this.isNewContext()){this.context=this.newContext;this.requestData()}},clear:function(){this.el.update(this.contentTemplate.apply(this));this.context=false}});Ext.namespace("Sage.Platform.Mobile");Ext.namespace("Sage.Platform.Mobile.Controls");Sage.Platform.Mobile.Controls.Field=function(a){this.name=a};Sage.Platform.Mobile.Controls.Field.prototype={apply:function(a){return this.template.apply(this)},bind:function(a){this.el=a.child(String.format('input[name="{0}"]',this.name))},isDirty:function(){return true}};Sage.Platform.Mobile.Controls.TextField=Ext.extend(Sage.Platform.Mobile.Controls.Field,{template:new Simplate(['<input type="text" name="{%= name %}">',]),getValue:function(){return this.el.getValue()},setValue:function(a){this.value=a;this.el.dom.value=a},isDirty:function(){return(this.value!=this.getValue())}});Sage.Platform.Mobile.Controls.registered={text:Sage.Platform.Mobile.Controls.TextField};Sage.Platform.Mobile.Edit=Ext.extend(Sage.Platform.Mobile.View,{viewTemplate:new Simplate(['<div id="{%= id %}" title="{%= title %}" class="panel">','<fieldset class="loading">','<div class="row"><div class="loading-indicator">loading...</div></div>',"</fieldset>",'<div class="body" style="display: none;">',"</div>","</div>"]),sectionBeginTemplate:new Simplate(['<h2>{%= $["title"] || "Details" %}</h2>','{% if ($["list"]) { %}<ul>{% } else { %}<fieldset>{% } %}']),sectionEndTemplate:new Simplate(['{% if ($["list"]) { %}</ul>{% } else { %}</fieldset>{% } %}']),propertyTemplate:new Simplate(['<div class="row row-edit">',"<label>{%= label %}</label>","{%! field %}","</div>"]),textFieldTemplate:new Simplate(['<input type="text" name="{%= name %}">']),constructor:function(a){Sage.Platform.Mobile.Edit.superclass.constructor.call(this);Ext.apply(this,a,{id:"generic_edit",title:"Edit",expose:false,canSave:true,fields:{}})},render:function(){Sage.Platform.Mobile.Edit.superclass.render.call(this);this.bodyEl=this.el.child(".body").setVisibilityMode(Ext.Element.DISPLAY);this.loadEl=this.el.child(".loading").setVisibilityMode(Ext.Element.DISPLAY)},init:function(){Sage.Platform.Mobile.Edit.superclass.init.call(this);this.processLayout(this.layout,{});for(var a in this.fields){this.fields[a].bind(this.el)}this.loadEl.hide();this.bodyEl.show();if(this.canSave){App.on("save",function(){if(this.el.getAttribute("selected")=="true"){this.save()}},this)}},createRequest:function(){},createTemplateRequest:function(){},processLayout:function(e,a){var h=[];var d=[];d.push(this.sectionBeginTemplate.apply(a));for(var b=0;b<e.length;b++){var g=e[b];if(g.as){h.push(g);continue}else{var c=Sage.Platform.Mobile.Controls.registered[g.type];var f=this.fields[g.name]=new c(g.name);d.push(this.propertyTemplate.apply({label:g.label,field:f}))}}d.push(this.sectionEndTemplate.apply(a));Ext.DomHelper.append(this.el,d.join(""));for(var b=0;b<h.length;b++){var g=h[b];this.processLayout(g.as,g.options)}},requestFailure:function(a,b){},requestData:function(){var a=this.createRequest();if(a){a.read({success:function(b){},failure:function(b,c){this.requestFailure(b,c)},scope:this})}},show:function(a){if(typeof a!=="undefined"){this.entry=a;this.newContext=true}else{this.newContext=false}Sage.Platform.Mobile.Edit.superclass.show.call(this)},isNewContext:function(){return this.newContext},beforeTransitionTo:function(){Sage.Platform.Mobile.Edit.superclass.beforeTransitionTo.call(this)},setValues:function(c){for(var a in this.fields){var b=Sage.Platform.Mobile.Utility.getValue(c,a);this.fields[a].setValue(b)}},getValues:function(){var d={};var c=true;for(var a in this.fields){if(this.fields[a].isDirty()){var b=this.fields[a].getValue();Sage.Platform.Mobile.Utility.setValue(d,a,b);c=false}}return c?false:d},createEntryForUpdate:function(a){return Ext.apply(a,{"$key":this.entry["$key"],"$etag":this.entry["$etag"],"$name":this.entry["$name"]})},save:function(){if(this.busy){return}var a=this.getValues();if(a){this.busy=true;this.el.addClass("view-busy");if(App.tbar){App.tbar.el.addClass("toolbar-busy")}var c=this.createEntryForUpdate(a);var b=this.createRequest();if(b){b.update(c,{success:function(d){this.busy=false;this.el.removeClass("view-busy");if(App.tbar){App.tbar.el.removeClass("toolbar-busy")}App.fireEvent("refresh",{resourceKind:this.resourceKind,key:d["$key"],data:{"$descriptor":d["$descriptor"]}});history.go(-1)},failure:function(d,e){this.busy=false;this.el.removeClass("view-busy");if(App.tbar){App.tbar.el.removeClass("toolbar-busy")}},scope:this})}}else{history.go(-1)}},transitionTo:function(){Sage.Platform.Mobile.Edit.superclass.transitionTo.call(this);if(this.isNewContext()){this.setValues(this.entry)}},clear:function(){}});Ext.namespace("Sage.Platform.Mobile");Sage.Platform.Mobile.Format=(function(){function c(d){if(typeof d!=="string"){return !d}return(d.length<=0)}function a(d){if(typeof d!=="string"){return d}return d.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function b(d){if(typeof d!=="string"){return d}return d.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"')}return{encode:a,isEmpty:c,link:function(d){if(typeof d!=="string"){return d}return String.format('<a target="_blank" href="http://{0}">{0}</a>',d)},mail:function(d){if(typeof d!=="string"){return d}return String.format('<a href="mailto:{0}">{0}</a>',d)},trim:function(d){return d.replace(/^\s+|\s+$/g,"")}}})();Ext.namespace("Sage.Platform.Mobile");Sage.Platform.Mobile.Toolbar=Ext.extend(Ext.util.Observable,{barTemplate:new Simplate(['<div class="{%= cls %}">','<h1 id="pageTitle">{%= title %}</h1>','<a id="backButton" class="button" href="#"></a>',"</div>"]),constructor:function(a){Sage.Platform.Mobile.Toolbar.superclass.constructor.call(this);Ext.apply(this,a,{cls:"toolbar",title:"Mobile"})},render:function(){this.el=Ext.DomHelper.append(Ext.getBody(),this.barTemplate.apply(this),true)},init:function(){this.render()},allowSearch:function(b,a){},allowEdit:function(a){},allowSave:function(a){}});Ext.namespace("Sage.Platform.Mobile");Sage.Platform.Mobile.Utility=(function(){var b={};var a=function(d){if(typeof d!=="string"){return[]}if(b[d]){return b[d]}var g=d.split(".");var f=[];for(var e=0;e<g.length;e++){var c=g[e].match(/([a-zA-Z0-9_]+)\[([^\]]+)\]/);if(c){f.push(c[1]);if(/^\d+$/.test(c[2])){f.push(parseInt(c[2]))}else{f.push(c[2])}}else{f.push(g[e])}}return(b[d]=f.reverse())};return{getValue:function(g,c){var f=a(c).slice(0);var e=g;while(e&&f.length>0){var d=f.pop();if(e[d]){e=e[d]}else{return null}}return e},setValue:function(i,c,h){var g=i;var f=a(c).slice(0);while((typeof g!=="undefined")&&f.length>1){var d=f.pop();if(f.length>0){var e=f[f.length-1];g=g[d]=(typeof g[d]!=="undefined")?g[d]:(typeof e==="number")?[]:{}}}if(typeof f[0]!=="undefined"){g[f[0]]=h}return i}}})();